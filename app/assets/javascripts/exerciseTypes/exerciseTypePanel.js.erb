var exerciseTypePanel = angular.module('exerciseTypes.exerciseTypePanel', [
  'util.filters.propsFilter',
  'util.promiseUi',
  'ui.bootstrap',
  'exerciseGroups.exerciseGroupsSelector'
]);

exerciseTypePanel.directive('exerciseTypePanel', [function () {
  return {
    restrict: 'E',
    scope: {
      onExerciseTypeClicked: '&',
      onExerciseTypeAddClicked: '&',
      onExerciseTypeDeleteClicked: '&',
      onExerciseTypeEditClicked: '&',
      editorUserId: '=',
      isAdminMode: '=',
      exerciseGroups: '=',
      exerciseTypes: '=',
      userExerciseTypePhotos: '='
    },
    templateUrl: '<%= asset_path('exerciseTypes/exercise-type-panel.html') %>',
    controller: ['$scope', function ($scope) {
      $scope.filter = {};
      $scope.selectedExerciseGroupIds = [];
      $scope.userExerciseTypePhotos.$promise.then(createExerciseTypeIdToPhotoMap);

      function createExerciseTypeIdToPhotoMap(exerciseTypePhotos) {
        $scope.exerciseTypeIdToThumbPath = _.object(_.map(exerciseTypePhotos, function (el) {
          return [el.exercise_type_id, el.thumb_image_url];
        }));
      }

      $scope.canEditExerciseType = function (exerciseType) {
        return exerciseType.owner_id == $scope.editorUserId || $scope.isAdminMode;
      };

      function getExerciseTyoePrimaryPhoto(exerciseType) {
        if ($scope.exerciseTypeIdToThumbPath) {
          var thumbPhotoSrc = $scope.exerciseTypeIdToThumbPath[exerciseType.id];
          if (thumbPhotoSrc) {
            return thumbPhotoSrc;
          }
        }
        return null;
      }

      function getFirstExerciseGroupPhoto(exerciseGroupIds) {
        var exerciseGroupPhoto = _.chain($scope.exerciseGroups)
          .filter(function (exerciseGroup) {
            return !exerciseGroup.thumb_image_url.startsWith('/photos/thumb/missing') &&
              _.contains(exerciseGroupIds, exerciseGroup.id);
          })
          .map(function (exerciseGroup) {
            return exerciseGroup.thumb_image_url;
          })
          .first()
          .value();
        return exerciseGroupPhoto;
      }

      $scope.getPrimaryPhoto = function (exerciseType) {
        return getExerciseTyoePrimaryPhoto(exerciseType) ||
          getFirstExerciseGroupPhoto(exerciseType.exercise_groups) ||
          'photos/exercise-types/thumb/weight1.png';
      };
    }]
  };
}]);

exerciseTypePanel.filter('bySelectedGroups', function () {
  return function (exerciseTypes, selectedGroupIds) {
    if (_.isEmpty(selectedGroupIds))
      return exerciseTypes;
    return _.filter(exerciseTypes, function (exerciseType) {
      return _.all(selectedGroupIds, function (selectedGroup) {
        return _.contains(exerciseType.exercise_groups, selectedGroup);
      });
    });
  };
});

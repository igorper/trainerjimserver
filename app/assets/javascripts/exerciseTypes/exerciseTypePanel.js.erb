var exerciseTypePanel = angular.module('exerciseTypes.exerciseTypePanel', [
  'users.exerciseTypes.photos',
  'util.filters.propsFilter',
  'util.promiseUi',
  'ui.bootstrap',
  'exerciseGroups.exerciseGroupsSelector',
  'toaster'
]);

exerciseTypePanel.directive('exerciseTypePanel', [function () {
  return {
    restrict: 'E',
    scope: {
      onExerciseTypeClicked: '&',
      onExerciseTypeAddClicked: '&',
      onExerciseTypeDeleteClicked: '&',
      onExerciseTypeEditClicked: '&',
      editorUserId: '=',
      isAdministrator: '=',
      exerciseGroups: '=',
      exerciseTypes: '=',
      userExerciseTypePhotos: '=?'
    },
    templateUrl: '<%= asset_path('exerciseTypes/exercise-type-panel.html') %>',
    controller: ['$scope', 'UserExerciseTypePhotos', function ($scope, UserExerciseTypePhotos) {
      $scope.filter = {};
      $scope.selectedExerciseGroupIds = [];

      if ($scope.userExerciseTypePhotos == undefined) {
        UserExerciseTypePhotos.primaryPhotos(initializePhotos);
      } else {
        initializePhotos($scope.userExerciseTypePhotos);
      }

      function initializePhotos(exerciseTypePhotos) {
        $scope.exerciseTypeIdToThumbPath = _.object(_.map(exerciseTypePhotos, function (el) {
          return [el.exercise_type_id, el.thumb_image_url];
        }));
      }

      $scope.canEditExerciseType = function (exerciseType) {
        return exerciseType.owner_id == $scope.editorUserId || $scope.isAdministrator;
      };

      $scope.getPrimaryPhoto = function (exerciseType) {
        if ($scope.exerciseTypeIdToThumbPath) {
          var thumbPhotoSrc = $scope.exerciseTypeIdToThumbPath[exerciseType.id];
          if (thumbPhotoSrc) {
            return thumbPhotoSrc;
          }
        }
        return 'photos/exercise-types/thumb/weight1.png';
      };
    }]
  };
}]);

exerciseTypePanel.filter('bySelectedGroups', function () {
  return function (exerciseTypes, selectedGroupIds) {
    if (_.isEmpty(selectedGroupIds))
      return exerciseTypes;
    return _.filter(exerciseTypes, function (exerciseType) {
      return _.all(selectedGroupIds, function (selectedGroup) {
        return _.contains(exerciseType.exercise_groups, selectedGroup);
      });
    });
  };
});

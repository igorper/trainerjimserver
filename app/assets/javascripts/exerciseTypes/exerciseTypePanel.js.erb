var exerciseTypePanel = angular.module('exerciseTypes.exerciseTypePanel', [
  'exerciseTypes.exerciseType',
  'users.exerciseTypes.photos',
  'util.filters.propsFilter',
  'util.promiseUi',
  'ui.bootstrap',
  'exerciseGroups.exerciseGroup'
]);

exerciseTypePanel.directive('exerciseTypePanel', [function () {
  return {
    restrict: 'E',
    scope: {onExerciseTypeClicked: '&'},
    templateUrl: '<%= asset_path('exerciseTypes/exercise-type-panel.html') %>',
    controller: ['$scope', 'ExerciseType', 'UserExerciseTypePhotos', 'ExerciseGroup', function ($scope, ExerciseType, UserExerciseTypePhotos, ExerciseGroup) {
      $scope.exerciseTypes = ExerciseType.query();
      $scope.NO_GROUP = 'noGroup';
      $scope.selectedGroup = $scope.NO_GROUP;

      $scope.getSelectedGroupId = function () {
        var selectedGroup = $scope.selectedGroup;
        var indexOfDash = selectedGroup.indexOf('-');
        return indexOfDash < 0 ? null : parseInt(selectedGroup.substring(indexOfDash + 1));
      };

      UserExerciseTypePhotos.primaryPhotos(function (exerciseTypePhotos) {
        $scope.exerciseTypeIdToThumbPath = _.object(_.map(exerciseTypePhotos, function (el) {
          return [el.exercise_type_id, el.thumb_image_url];
        }));
      });

      $scope.exerciseGroups = ExerciseGroup.query();

      $scope.getPrimaryPhoto = function (exerciseType) {
        if ($scope.exerciseTypeIdToThumbPath) {
          var thumbPhotoSrc = $scope.exerciseTypeIdToThumbPath[exerciseType.id];
          if (thumbPhotoSrc) {
            return thumbPhotoSrc;
          }
        }
        return 'images/medium/missing.png';
      };
    }]
  };
}]);

exerciseTypePanel.filter('bySelectedGroup', function () {
  return function (items, selectedGroup) {
    if (selectedGroup === null)
      return items;
    return _.filter(items, function (el) {
      return _.contains(el.exercise_groups, selectedGroup);
    });
  };
});

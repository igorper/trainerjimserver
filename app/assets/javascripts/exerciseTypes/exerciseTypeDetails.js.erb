var exerciseTypeDetailsModule = angular.module("exerciseTypes.exerciseTypeDetails", [
  'ui.bootstrap',
  'exerciseTypes.exerciseType',
  'users.exerciseTypes.photos',
  'photos.photoThumb',
  'photos.photoCarousel',
  'angularSpinner',
  'photos.takePhotoDialog'
]);

exerciseTypeDetailsModule.directive('exerciseTypeDetails', function () {
  return {
    restrict: 'E',
    scope: {
      'exerciseTypeId': '=',
      'userId': '=',
      'trainer': '='
    },
    controller: ['$scope', 'ExerciseType', 'UserExerciseTypePhotos', 'usSpinnerService', 'TakePhotoDialog', 'PhotoCarouselDialog', function ($scope, ExerciseType, UserExerciseTypePhotos, usSpinnerService, TakePhotoDialog, PhotoCarouselDialog) {
      $scope.exerciseType = ExerciseType.get({id: $scope.exerciseTypeId});

      function refreshPhotos() {
        $scope.userPhotos = UserExerciseTypePhotos.query({
          userId: $scope.userId,
          exerciseTypeId: $scope.exerciseTypeId
        });
      }

      refreshPhotos();

      $scope.canDeletePhoto = function (photo) {
        return photo.user_id == $scope.userId || ($scope.trainer && photo.user_id == $scope.trainer.id);
      };

      $scope.onDeletePhotoClicked = function (photo) {
        photo.$delete().then(refreshPhotos);
      };

      $scope.onPhotoClicked = function (photoIndex) {
        PhotoCarouselDialog($scope.userPhotos, photoIndex);
      };


      function startSpinner() {
        usSpinnerService.spin('exercise-type-details-photo-upload-spinner');
      }

      function stopSpinner() {
        usSpinnerService.stop('exercise-type-details-photo-upload-spinner');
      }

      function uploadExerciseTypePhoto(photo) {
        startSpinner();
        UserExerciseTypePhotos.add($scope.userId, $scope.exerciseTypeId, photo)
          .then(function () {
            refreshPhotos();
            stopSpinner();
          }, stopSpinner);
      }

      $scope.onTakePhotoClicked = function () {
        TakePhotoDialog().result
          .then(function (photos) {
            uploadExerciseTypePhoto(photos[0]);
          });
      };
    }],
    templateUrl: "<%= asset_path('exerciseTypes/exercise-type-details.html') %>"
  };
});


exerciseTypeDetailsModule.factory('ExerciseTypeDetailsDialog', ['$modal', function ($modal) {
  return function (userId, exerciseTypeId) {
    return $modal.open({
      templateUrl: '<%= asset_path('exerciseTypes/exercise-type-details-dialog.html') %>',
      backdrop: 'static',
      windowClass: 'modal-window',
      size: 'lg',
      controller: ['$scope', function ($scope) {
        $scope.exerciseTypeId = exerciseTypeId;
        $scope.userId = userId;

        $scope.onCloseClicked = function () {
          $scope.$dismiss();
        };
      }
      ]
    });
  };
}]);
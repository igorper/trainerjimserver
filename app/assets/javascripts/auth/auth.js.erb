//= require angular-resource/angular-resource

var authModule = angular.module("auth", ["ngResource"]);

var USER_CHANGED_EVENT = 'event:user.changed';

authModule.factory("Auth", ['$resource', '$rootScope', function ($resource, $rootScope) {
  var resource = $resource("/api/v1/auth/:action.json", null,
    {
      login: {method: 'POST', params: {action: 'login'}},
      signup: {method: 'POST', params: {action: 'signup'}},
      logout: {method: 'POST', params: {action: 'logout'}},
      userDetails: {method: 'GET', params: {action: 'user_details'}},
      isLoggedIn: {method: 'GET', params: {action: 'is_logged_in'}}
    });

  return {
    login: function (params, successCallback, failureCallback) {
      return resource.login(params, function (data) {
        $rootScope.$broadcast(USER_CHANGED_EVENT, data);
        successCallback(data);
      }, failureCallback);
    },
    signup: function (params, successCallback, failureCallback) {
      return resource.signup(params, successCallback, failureCallback);
    },
    userDetails: resource.userDetails,
    isLoggedIn: resource.isLoggedIn,
    logout: resource.logout
  };
}]);
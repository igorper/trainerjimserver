var promiseSpinner = angular.module('util.promiseSpinner', []);

promiseSpinner.directive('promiseSpinner', ['$window', function ($window) {
  return {
    restrict: 'E',
    scope: {
      promise: '='
    },
    templateUrl: "<%= asset_path('util/promise-spinner.html') %>",
    link: function (scope, element) {
      var spinner = new $window.Spinner();
      var spinnnerElement = element.children()[0];

      function onPromiseFulfilled() {
        scope.isPromiseFulfilled = true;
        spinner.stop(spinnnerElement);
      }

      function onPromiseStarted() {
        scope.isPromiseFulfilled = false;
        spinner.spin(spinnnerElement);
      }

      onPromiseFulfilled();

      function getPromise() {
        if (scope.promise) {
          if (scope.promise.$promise && scope.promise.$promise.then) {
            return scope.promise.$promise;
          } else if (scope.promise.then) {
            return scope.promise;
          }
        }
        return null;
      }

      scope.$watch('promise', function () {
          var promise = getPromise();
          if (promise) {
            onPromiseStarted();
            promise.then(onPromiseFulfilled, onPromiseFulfilled);
          }
        }
      );
    }
  };
}]);

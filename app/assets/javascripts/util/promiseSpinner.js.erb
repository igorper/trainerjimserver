var promiseSpinner = angular.module('util.promiseSpinner', []);

promiseSpinner.directive('promiseSpinner', ['$window', function ($window) {
  return {
    scope: {promise: '='},
    transclude: true,
    templateUrl: "<%= asset_path('util/promise-spinner.html') %>",
    link: function (scope, element) {
      var spinner = new $window.Spinner();
      var spinnerElement = element.children()[0];

      function stopSpinning() {
        spinner.stop(spinnerElement);
      }

      stopSpinning();

      function getPromise() {
        if (scope.promise) {
          if (scope.promise.$promise && scope.promise.$promise.then) {
            return scope.promise.$promise;
          } else if (scope.promise.then) {
            return scope.promise;
          }
        }
        return null;
      }

      scope.$watch('promise', function () {
          var promise = getPromise();
          if (promise) {
            spinner.spin(spinnerElement);
            promise.then(stopSpinning, stopSpinning);
          }
        }
      );
    }
  };
}]);

var workouts = angular.module('workouts', [
  'workouts.editor',
  'ui.router',
  'ui.bootstrap',
  'trainings',
  'trainees.traineeThumb',
  'users',
  'toaster'
]);

workouts.config(['$stateProvider', function ($stateProvider) {
  $stateProvider.state('main.workouts', {
    url: '/workouts',
    abstract: true,
    controller: ['$scope', '$state', 'WorkoutsCtrlHelper', function ($scope, $state, WorkoutsCtrlHelper) {
      WorkoutsCtrlHelper($scope, {workoutStateName: 'main.workouts.workout'});
    }],
    templateUrl: '<%= asset_path('workouts/workouts.html') %>'
  });

  $stateProvider.state('main.workouts.workout', {
    url: '/:trainingId',
    controller: ['$scope', '$stateParams', 'WorkoutCtrlHelper', function ($scope, $stateParams, WorkoutCtrlHelper) {
      WorkoutCtrlHelper($scope, {trainingId: $stateParams.trainingId});
    }],
    templateUrl: '<%= asset_path('workouts/workout.html') %>'
  });
}]);

workouts.directive('workoutsList', function () {
  return {
    restrict: 'E',
    scope: {
      workouts: '=',
      selectedWorkout: '=',
      onWorkoutSelected: '&',
      onWorkoutCreate: '&'
    },
    templateUrl: "<%= asset_path('workouts/list/workouts-list.html') %>"
  };
});

workouts.factory('WorkoutsCtrlHelper', ['toaster', 'Training', 'User', 'TraineeTraining', 'Trainee', '$state', 'WorkoutSelector',
  function (toaster, Training, User, TraineeTraining, Trainee, $state, WorkoutSelector) {
    return function ($scope, workoutsConfig) {
      $scope.workoutsContext = angular.extend({
        workoutStateName: 'main.workouts.workout',
        traineeId: null,
        title: 'Workouts',
        trainingList: [],
        trainer: User.current(),
        trainee: null,
        addPreparedWorkout: null, // fn(trainingId:Int, successCallback, failureCallback)
        fetchTrainingsList: Training.query,
        fetchTrainee: User.current
      }, workoutsConfig);

      $scope.onAddPreparedWorkoutClicked = function () {
        WorkoutSelector().result.then(function (selectedTraining) {
          $scope.workoutsContext.addPreparedWorkout(selectedTraining.id, function (training) {
              toaster.pop("success", "Training saved", "Successfully saved " + training.name);
              $scope.onWorkoutSelected(training);
              refreshTrainingsList();
            },
            function () {
              toaster.pop("error", "Prepared training not added", "An error occurred while trying add the prepared training.");
            }
          );
        });
      };

      $scope.onWorkoutSelected = function (training) {
        $state.go($scope.workoutsContext.workoutStateName, {trainingId: training.id});
      };

      $scope.onWorkoutCreate = function () {
        $state.go($scope.workoutsContext.workoutStateName, {trainingId: ''});
      };

      $scope.refreshUserDetails = function () {
        $scope.workoutsContext.fetchTrainee(function (trainee) {
          $scope.workoutsContext.trainee = trainee;
        }, function () {
          toaster.pop("error", "Avatar not loaded", "Could show the avatar. Try logging in again.");
        });
      };

      $scope.refreshTrainingsList = function () {
        $scope.workoutsContext.fetchTrainingsList(function (trainings) {
            $scope.workoutsContext.trainingList = trainings;
          },
          function () {
            toaster.pop("error", "Fetch workouts error", "Unable to fetch the list of workouts.");
          }
        );
      };

      $scope.refreshUserDetails();
      $scope.refreshTrainingsList();
    };
  }]);


workouts.factory('WorkoutCtrlHelper', ['$state', 'Training', 'toaster', function ($state, Training, toaster) {
  return function ($scope, workoutConfig) {
    $scope.workoutsContext = angular.extend($scope.workoutsContext, angular.extend({
      trainingId: '',
      saveTraining: function (successCallback, failureCallback) {
        $scope.workoutsContext.selectedTraining.$save({traineeId: $scope.workoutsContext.traineeId}, successCallback, failureCallback);
      },
      createEmptyTraining: function () {
        return new Training({name: "Enter training name", exercises: []});
      },
      fetchTraining: function (successCallback, failureCallback) {
        Training.get({id: $scope.workoutsContext.trainingId}, successCallback, failureCallback);
      },
      deleteTraining: function (successCallback, failureCallback) {
        Training.delete({id: $scope.workoutsContext.trainingId}, successCallback, failureCallback);
      }
    }, workoutConfig));


    if ($scope.workoutsContext.trainingId === '') {
      $scope.workoutsContext.selectedTraining = $scope.workoutsContext.createEmptyTraining();
    } else {
      $scope.workoutsContext.fetchTraining(function (training) {
        $scope.workoutsContext.selectedTraining = training;
      }, function () {
        toaster.pop("error", "Fetch workout error", "Unable to fetch the workout.");
      });
    }

    $scope.onSaveClicked = function () {
      $scope.workoutsContext.saveTraining(function (training) {
        toaster.pop("success", "Training saved", "Sucessfully saved " + training.name);
        $state.go($scope.workoutsContext.workoutStateName, {trainingId: training.id});
        $scope.refreshTrainingsList();
      }, function () {
        toaster.pop("error", "Training save error", "Error saving " + training.name);
      });
    };

    $scope.onDeleteClicked = function () {
      $scope.workoutsContext.deleteTraining(function () {
        toaster.pop("info", "Workout deleted", "The workout was successfully deleted.");
        $state.go($scope.workoutsContext.workoutStateName, {trainingId: ''});
        $scope.refreshTrainingsList();
      }, function () {
        toaster.pop("error", "Workout not deleted", "Could not delete the workout. Please try logging in again.");
      });
    };
  };
}]);
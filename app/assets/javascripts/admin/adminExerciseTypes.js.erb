//= require exerciseTypes/exerciseTypeEditDialog

var admin = angular.module('admin.exerciseTypes', [
  'ui.router',
  'ui.bootstrap',
  'exerciseTypes.exerciseType',
  'exerciseTypes.exerciseTypeEditDialog',
  'exerciseTypes.exerciseTypeDetails'
]);

admin.config(['$stateProvider', function ($stateProvider) {
  $stateProvider
    .state('main.admin.exerciseTypes', {
      url: '/exerciseTypes?page',
      templateUrl: "<%= asset_path('admin/admin-exercise-types.html') %>",
      controller: ['$scope', 'ExerciseType', 'ExerciseTypeEditDialog', 'ExerciseTypeDetailsDialog', 'toaster', '$stateParams', '$state', 'Auth', function ($scope, ExerciseType, ExerciseTypeEditDialog, ExerciseTypeDetailsDialog, toaster, $stateParams, $state, Auth) {

        $scope.userDetails = Auth.userDetails();

        $scope.changePage = function () {
          $state.go('main.admin.exerciseTypes', {page: $scope.currentPage});
        };

        function getCurrentPage() {
          return $stateParams.page == undefined ? 1 : parseInt($stateParams.page);
        }

        function refreshPaginationInfo() {
          $scope.paginationInfo = ExerciseType.paginationInfo(function (data) {
            // NOTE: we update current page here because the paginator forcefully updates it to '1' before the
            // paginationInfo promise is fulfilled. This then forces a changePage.
            $scope.currentPage = getCurrentPage();
          });
        }

        function refreshExerciseTypes() {
          $scope.exerciseTypes = ExerciseType.query({page: getCurrentPage()});
          refreshPaginationInfo();
        }

        refreshExerciseTypes();

        $scope.onCreateExerciseTypeClicked = function () {
          ExerciseTypeEditDialog()
            .result.then(refreshExerciseTypes);
        };

        $scope.onExerciseClicked = function (exerciseType) {
          ExerciseTypeDetailsDialog($scope.userDetails.id, exerciseType.id);
        };

        $scope.onEditExerciseClicked = function (exerciseType) {
          ExerciseTypeEditDialog(angular.copy(exerciseType))
            .result.then(refreshExerciseTypes);
        };

        $scope.onDeleteExerciseClicked = function (exerciseType) {
          ExerciseType.delete({id: exerciseType.id}, refreshExerciseTypes, function (errorData) {
            toaster.pop("error", "Exercise type not deleted", "Could not delete the exercise type. The exercise type is in use.");
          });
        };
      }]
    })
  ;
}])
;
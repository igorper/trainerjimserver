var createUserDialog = angular.module('users.createUserDialog', [
  'users',
  'ui.bootstrap',
  'util.promiseSpinner'
]);

createUserDialog.factory('CreateUserDialog', ['$modal', 'User', '$q', function ($modal, User, $q) {
  return function (options) {
    return $modal.open({
      templateUrl: '<%= asset_path('users/create-user-dialog.html') %>',
      backdrop: 'static',
      windowClass: 'modal-window',
      controller: ['$scope', function ($scope) {

        $scope.options = angular.extend({
          dialogTitle: 'New user',
          isTrainer: false,
          createUser: function () {
            return new User({
              is_trainer: $scope.options.isTrainer
            });
          },
          saveUser: function (user, photo) {
            return $q(function (resolve, reject) {
              User.create(user, photo)
                .then(function (response) {
                  resolve(new User(response.data));
                }, reject);
            });
          }
        }, options);


        $scope.user = $scope.options.createUser();
        $scope.title = $scope.options.dialogTitle;
        $scope.onCreateClicked = function () {
          var photo = $scope.photos ? $scope.photos[0] : null;
          $scope.uploadedPromise = $scope.options.saveUser($scope.user, photo).then(function (user) {
            $scope.$close(user);
          });
        };
      }]
    });
  };
}]);
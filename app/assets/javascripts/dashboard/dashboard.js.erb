var dashboard = angular.module('dashboard', [
  'ui.router',
  'results',
  'nvd3',
  'exerciseGroups.exerciseGroup',
  'util.promiseUi',
  'measurements.stats',
  'dashboard.overview',
  'dashboard.user',
  'dashboard.user.summary',
  'dashboard.user.calendar',
  'dashboard.user.calendar.overview',
  'dashboard.user.calendar.details'
]);


dashboard.config(['$stateProvider', function ($stateProvider) {
  $stateProvider.state('main.dashboard', {
    url: '/dashboard',
    abstract: true,
    templateUrl: '<%= asset_path('dashboard/dashboard.html') %>',
    controller: 'DashboardCtrl'  });

  $stateProvider.state('main.dashboard.overview', {
    url: '/',
    templateUrl: '<%= asset_path('dashboard/dashboard-overview.html') %>',
    controller: 'DashboardOverviewCtrl'
  });

  $stateProvider.state('main.dashboard.user', {
    url: '/:userId',
    templateUrl: '<%= asset_path('dashboard/dashboard-user.html') %>',
    controller: 'DashboardUserCtrl'
  });

  $stateProvider.state('main.dashboard.user.summary', {
    url: '/summary/:filter',
    templateUrl: '<%= asset_path('dashboard/dashboard-user-summary.html') %>',
    controller: 'DashboardUserSummaryCtrl',
    params:{
      filter: 'all'
    }
  });

  $stateProvider.state('main.dashboard.user.calendar', {
    url: '/calendar/:trainingId',
    templateUrl: '<%= asset_path('dashboard/dashboard-user-calendar.html') %>',
    controller: 'DashboardUserCalendarCtrl'
  });

  $stateProvider.state('main.dashboard.user.calendar.overview', {
    url: '/overview',
    templateUrl: '<%= asset_path('dashboard/dashboard-user-calendar-overview.html') %>',
    controller: 'DashboardUserCalendarOverviewCtrl'
  });

  $stateProvider.state('main.dashboard.user.calendar.details', {
    url: '/details',
    templateUrl: '<%= asset_path('dashboard/dashboard-user-calendar-details.html') %>',
    controller: 'DashboardUserCalendarDetailsCtrl'
  });
}]);


dashboard.controller('DashboardCtrl', ['$scope', 'Trainee', '$state', 'toaster', function ($scope, Trainee, $state, toaster) {
    $scope.state = $state;

    $scope.users = Trainee.query(_.noop, function () {
      toaster.pop("error", "Trainees listing", "Could get the list of trainees. Try logging in again.");
    });

    $scope.getCurrentUserId = function () {
      return $state.params.userId === undefined ? null : parseInt($state.params.userId);
    };

    $scope.onUserSelected = function (user) {
      if (_.isUndefined(user)) {
        $state.go('main.dashboard.overview');
      } else {
        $state.go('main.dashboard.user.summary', {userId: user.id, filter: 'all'});
      }
    };
  }]
);
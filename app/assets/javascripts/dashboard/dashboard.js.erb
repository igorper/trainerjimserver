var dashboard = angular.module('dashboard', [
  'ui.router',
  'results',
  'nvd3',
  'exerciseGroups.exerciseGroup',
  'util.promiseUi',
  'measurements.stats',
  'dashboard.overview',
  'dashboard.user'
]);


dashboard.config(['$stateProvider', function ($stateProvider) {
  $stateProvider.state('main.dashboard', {
    url: '/dashboard',
    abstract: true,
    templateUrl: '<%= asset_path('dashboard/dashboard.html') %>',
    controller: 'DashboardCtrl'  });

  $stateProvider.state('main.dashboard.overview', {
    url: '/',
    templateUrl: '<%= asset_path('dashboard/dashboard-overview.html') %>',
    controller: 'DashboardOverviewCtrl'
  });

  $stateProvider.state('main.dashboard.user', {
    url: '/:userId',
    templateUrl: '<%= asset_path('dashboard/dashboard-user.html') %>',
    controller: 'DashboardUserCtrl'
  });
}]);


dashboard.controller('DashboardCtrl', ['$scope', 'Trainee', '$state', 'toaster', function ($scope, Trainee, $state, toaster) {
    $scope.state = $state;

    $scope.users = Trainee.query(_.noop, function () {
      toaster.pop("error", "Trainees listing", "Could get the list of trainees. Try logging in again.");
    });

    $scope.getCurrentUserId = function () {
      return $state.params.id == "" ? null : parseInt($state.params.id);
    };

    $scope.onUserSelected = function (user) {
      if (_.isUndefined(user)) {
        $state.go('main.dashboard.overview');
      } else {
        $state.go('main.dashboard.user', {userId: user.id});
      }
    };
  }]
);